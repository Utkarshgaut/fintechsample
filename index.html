<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinLedgerBook By Utkarsh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            /* --color-bg-page: #251510;
            --color-bg-card: #67684a;
            --color-text-light: #F7FAFC;
            --color-text-dark: #A0AEC0;
            --color-border: #718096;
            --color-yellow: #F6E05E;
            --color-red: #F56565;
            --color-blue: #63B3ED;
            --color-green: #68D391; */



            /* --color-bg-page: #6e6f72;
            --color-bg-card: #1c1f24;
            --color-text-light: #F7FAFC;
            --color-text-dark: #A0AEC0; */

            --color-bg-page: #111827;
            --color-bg-card: #1F2937;
            --color-bg-input: #374151;
            --color-border: #4B5563;

            --color-text-light: #F9FAFB;
            --color-text-dark: #9CA3AF;

            /* --color-border: #070707; */
            --color-yellow: #f6e05e;
            --color-red: #F56565;
            --color-blue: #fbd70d;
            --color-green: #68D391;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-page);
            color: var(--color-text-light);
        }

        .card {
            background-color: var(--color-bg-card);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            color: var(--color-text-light);
        }

        .sidebar-input {
            position: sticky;
            top: 1rem;
            height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .tab-button {
            transition: color 0.2s, border-bottom 0.2s;
            color: var(--color-text-dark);
        }

        .tab-button.active {
            color: var(--color-blue);
            border-bottom: 3px solid var(--color-blue);
            font-weight: 600;
        }

        input, select, textarea {
            background-color: #2D3748;
            border-color: var(--color-border);
            color: var(--color-text-light);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--color-blue) !important;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5) !important;
            outline: none !important;
        }

        @media (max-width: 1024px) {
            .sidebar-input {
                position: relative;
                top: 0;
                height: auto;
                max-height: none;
                overflow-y: visible;
            }
        }
        
        @media print {
            body > div#app, body > #auth-container { display: none; }
            body > #invoicePrintContainer {
                visibility: visible !important; opacity: 1 !important; display: block !important;
                position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                background-color: white !important; box-shadow: none !important; margin: 0; padding: 0;
            }
            #invoiceTemplate { width: 100%; margin: 0; padding: 20px; box-shadow: none !important; border-radius: 0 !important; }
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: right;
            padding: 10px;
            font-weight: bold;
            font-size: 14px;
            color: var(--color-text-dark);
        }
    </style>
</head>
<body>

    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full p-6">
            <div id="signin-form" class="card p-8">
                <h2 class="text-2xl font-bold text-center text-white mb-6">Sign In</h2>
                <div class="space-y-4">
                    <input type="email" placeholder="Email" class="w-full p-3 rounded-lg border border-gray-600">
                    <input type="password" placeholder="Password" class="w-full p-3 rounded-lg border border-gray-600">
                    <button onclick="signIn()" class="w-full text-white font-bold py-3 rounded-lg" style="background-color: var(--color-blue);">Sign In</button>
                </div>
                <p class="text-center mt-4 text-sm">Don't have an account? <a href="#" onclick="toggleAuthForms()" class="hover:underline" style="color: var(--color-blue);">Sign Up</a></p>
            </div>
            <div id="signup-form" class="card p-8" style="display: none;">
                <h2 class="text-2xl font-bold text-center text-white mb-6">Sign Up</h2>
                <div class="space-y-4">
                    <input type="text" placeholder="Full Name" class="w-full p-3 rounded-lg border border-gray-600">
                    <input type="email" placeholder="Email" class="w-full p-3 rounded-lg border-gray-600">
                    <input type="password" placeholder="Password" class="w-full p-3 rounded-lg border border-gray-600">
                    <button onclick="signUp()" class="w-full text-white font-bold py-3 rounded-lg" style="background-color: var(--color-green);">Sign Up</button>
                </div>
                <p class="text-center mt-4 text-sm">Already have an account? <a href="#" onclick="toggleAuthForms()" class="hover:underline" style="color: var(--color-blue);">Sign In</a></p>
            </div>
        </div>
    </div>

    <div id="app" class="flex flex-col min-h-screen antialiased" style="display: none;">
        
        <header class="flex-shrink-0 card p-4 flex flex-wrap justify-start items-center z-20 sticky top-0 shadow-md">
            <h1 class="text-3xl font-extrabold tracking-tight lg:mr-8 mb-2 lg:mb-0" style="color: var(--color-blue);">FinLedger Book By Utkarsh</h1>
            <nav class="flex space-x-4 sm:space-x-6 overflow-x-auto whitespace-nowrap flex-1 justify-start">
                <button class="tab-button px-2 py-1 text-sm font-medium" data-tab="ledger">Bookkeeping Ledger</button>
                <button class="tab-button px-2 py-1 text-sm font-medium" data-tab="analysis">Analysis & Reporting</button>
                <button class="tab-button px-2 py-1 text-sm font-medium" data-tab="invoicing">Invoicing</button>
                <button class="tab-button px-2 py-1 text-sm font-medium" data-tab="payroll">Payroll & Capital</button>
            </nav>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row p-4 lg:p-6 gap-6">
            
            <div class="lg:w-1/3 w-full flex-shrink-0">
                <div class="card p-6 sidebar-input flex flex-col">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3 flex items-center" style="border-color: var(--color-border);">
                        <i data-lucide="file-plus" class="w-6 h-6 mr-3" style="color: var(--color-blue);"></i> Record Transaction
                    </h2>
                    <div id="input-form" class="space-y-5 flex-grow">
                        <label class="block">
                            <span class="text-sm font-medium" style="color: var(--color-text-dark);">Date</span>
                            <input type="date" id="dateInput" class="mt-1 block w-full rounded-lg border shadow-inner p-3" style="border-color: var(--color-border);">
                        </label>
                        <div class="flex space-x-4">
                            <label class="block flex-1">
                                <span class="text-sm font-medium" style="color: var(--color-text-dark);">Type</span>
                                <select id="typeSelect" onchange="updateCategoryDropdown(); updateCalculations();" class="mt-1 block w-full rounded-lg border shadow-inner p-3" style="border-color: var(--color-border);">
                                    <option value="Expense">Expense</option>
                                    <option value="Income">Income</option>
                                </select>
                            </label>
                            <label class="block flex-1">
                                <span class="text-sm font-medium" style="color: var(--color-text-dark);">Category</span>
                                <select id="categorySelect" onchange="updateCalculations()" class="mt-1 block w-full rounded-lg border shadow-inner p-3" style="border-color: var(--color-border);"></select>
                            </label>
                        </div>
                        <label class="block">
                            <span class="text-sm font-medium" style="color: var(--color-text-dark);">Description / Vendor</span>
                            <input type="text" id="descriptionInput" oninput="updateCalculations()" placeholder="e.g., Client Fee, AWS Subscription" class="mt-1 block w-full rounded-lg border shadow-inner p-3" style="border-color: var(--color-border);">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium" style="color: var(--color-text-dark);">Amount (Net Value)</span>
                            <input type="number" id="amountInput" oninput="updateCalculations()" placeholder="100.00" class="mt-1 block w-full rounded-lg border shadow-inner p-3" style="border-color: var(--color-border);">
                        </label>
                    </div>
                    <div class="mt-8 p-4 border-2 border-dashed rounded-xl" style="border-color: var(--color-blue); background-color: #2D3748;">
                        <p class="text-base font-semibold mb-1">Classification Summary</p>
                        <p id="calcCategory" class="text-sm font-medium" style="color: var(--color-blue);">Category: [Waiting for Input]</p>
                        <p id="calcValue" class="text-2xl font-extrabold mt-2">Bookkeeping Value: $0.00</p>
                    </div>
                    <div class="mt-6 space-y-3">
                        <button onclick="addTransaction()" id="recordButton" class="w-full text-white font-bold py-4 px-4 rounded-xl shadow-lg transition duration-200 flex items-center justify-center" style="background-color: var(--color-blue);" disabled>
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i> RECORD TRANSACTION
                        </button>
                        <button onclick="exportData()" class="w-full font-bold py-3 px-4 rounded-xl shadow-sm transition duration-200 flex items-center justify-center" style="background-color: #718096;">
                            <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Ledger (CSV)
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:w-2/3 w-full flex-shrink-0">
                <div id="report-panel" class="space-y-6">
                    <div id="ledger" class="tab-content">
                        <h2 class="text-2xl font-bold mb-4">Transaction History Ledger</h2>
                        <div class="card p-6">
                            <div class="overflow-x-auto">
                                <table class="min-w-full" style="divide-color: var(--color-border);">
                                    <thead style="background-color: #2D3748;">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-xl" style="color: var(--color-text-dark);">ID</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--color-text-dark);">Date</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--color-text-dark);">Type</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--color-text-dark);">Description</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider" style="color: var(--color-text-dark);">Value ($)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-xl" style="color: var(--color-text-dark);">Category</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ledgerBody" class="divide-y" style="background-color: var(--color-bg-card); divide-color: var(--color-border);"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="analysis" class="tab-content">
                        <h2 class="text-2xl font-bold mb-4">Financial Reports & Visuals</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="card p-6 border-l-4" style="border-color: var(--color-green);">
                                <p class="text-sm font-medium" style="color: var(--color-text-dark);">Total Income (Net)</p>
                                <p id="summaryIncome" class="text-3xl font-extrabold mt-1" style="color: var(--color-green);">$0.00</p>
                            </div>
                            <div class="card p-6 border-l-4" style="border-color: var(--color-red);">
                                <p class="text-sm font-medium" style="color: var(--color-text-dark);">Total Expense (Net)</p>
                                <p id="summaryExpense" class="text-3xl font-extrabold mt-1" style="color: var(--color-red);">$0.00</p>
                            </div>
                            <div class="card p-6 border-l-4" style="border-color: var(--color-blue);">
                                <p class="text-sm font-medium" style="color: var(--color-text-dark);">Net Profit / Loss</p>
                                <p id="summaryNet" class="text-3xl font-extrabold mt-1" style="color: var(--color-blue);">$0.00</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div class="card p-6 lg:col-span-1">
                                <h3 class="text-lg font-bold mb-4">Total Net Flow</h3>
                                <div class="chart-container w-full h-64 flex justify-center items-center"><canvas id="netFlowChart"></canvas></div>
                            </div>
                            <div class="card p-6 lg:col-span-2">
                                <h3 class="text-lg font-bold mb-4">Expense Breakdown by Category</h3>
                                <div class="chart-container w-full lg:h-64 h-64"><canvas id="expenseCategoryChart"></canvas></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div id="PnLStatement" class="card p-6">
                                <h3 class="text-xl font-extrabold mb-4 border-b pb-2" style="color: var(--color-blue); border-color: var(--color-border);">Profit & Loss Statement (YTD)</h3>
                                <div id="pnlBody" class="overflow-x-auto"></div>
                            </div>
                            <div id="BalanceSheet" class="card p-6">
                                <h3 class="text-xl font-extrabold mb-4 border-b pb-2" style="color: var(--color-yellow); border-color: var(--color-border);">Balance Sheet <span class="text-xs" style="color: var(--color-text-dark);">(A=L+E)</span></h3>
                                <div id="bsBody" class="overflow-x-auto"></div>
                            </div>
                        </div>
                    </div>

                    <div id="invoicing" class="tab-content">
                        <h2 class="text-2xl font-bold mb-4">Professional Invoice Generation</h2>
                        <div class="card p-6">
                            <p class="mb-6" style="color: var(--color-text-dark);">Create a professional, print-optimized invoice that can be saved as a **PDF**.</p>
                            <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="border-color: var(--color-border);">Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border p-4 rounded-xl mb-8" style="background-color: #2D3748; border-color: var(--color-border);">
                                <label class="block"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Your Company Name</span><input type="text" id="companyName" oninput="updateInvoiceDisplay()" value="FinLedger Pro Services" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                                <label class="block"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Your Company Address</span><input type="text" id="companyAddress" oninput="updateInvoiceDisplay()" value="123 Financial Lane, Tech City, USA" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                                <label class="block"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Client Name</span><input type="text" id="invoiceClientName" oninput="updateInvoiceDisplay()" placeholder="Acme Corp" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                                <label class="block"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Client Email</span><input type="email" id="invoiceClientEmail" oninput="updateInvoiceDisplay()" placeholder="client@corp.com" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 items-end">
                                <label class="block md:col-span-2"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Service Description</span><input type="text" id="invoiceDescription" oninput="updateInvoiceDisplay()" placeholder="Consulting Services (30 Hrs)" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                                <label class="block"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Net Price ($)</span><input type="number" id="invoiceNetPrice" oninput="updateInvoiceCalculations(); updateInvoiceDisplay();" placeholder="5000.00" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                                <label class="block"><span class="text-sm font-medium" style="color: var(--color-text-dark);">Tax Rate (%)</span><input type="number" id="invoiceGstRate" oninput="updateInvoiceCalculations(); updateInvoiceDisplay();" value="15" class="mt-1 block w-full rounded-lg border shadow-sm p-2" style="border-color: var(--color-border);"></label>
                                <div id="invoiceCalcOutput" class="md:col-span-4 text-sm font-medium p-3 rounded-lg" style="background-color: var(--color-yellow); color: #2D3748;">
                                    Enter details to calculate Tax/Total.
                                </div>
                            </div>
                            <h3 class="text-lg font-semibold mb-3">Invoice Preview:</h3>
                            <div id="invoicePreview" class="p-6 border rounded-lg shadow-inner min-h-80 overflow-x-auto" style="background-color: #2D3748; border-color: var(--color-border);"></div>
                            <div class="mt-6 text-right">
                                <button onclick="downloadInvoice()" class="text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-200 flex items-center justify-center ml-auto" style="background-color: var(--color-red);">
                                    <i data-lucide="printer" class="w-5 h-5 mr-2"></i> Print / Save as PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="payroll" class="tab-content">
                        <h2 class="text-2xl font-bold mb-4">Payroll & Capital Management</h2>
                        <div class="card p-6 mb-6">
                            <h3 class="text-xl font-extrabold mb-4 border-b pb-2" style="color: var(--color-green); border-color: var(--color-border);">Employee Payroll</h3>
                            <p class="text-sm mb-4" style="color: var(--color-text-dark);">Process payroll to generate **Salaries Expense** and **Tax Payable Liability**.</p>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 border p-4 rounded-xl mb-6" style="background-color: #2D3748; border-color: var(--color-border);">
                                <input type="text" id="employeeName" placeholder="Employee Name" class="p-3 border rounded-lg md:col-span-1" style="border-color: var(--color-border);">
                                <input type="number" id="employeeSalary" placeholder="Annual Salary (e.g., 60000)" class="p-3 border rounded-lg" style="border-color: var(--color-border);">
                                <input type="number" id="employeeTaxRate" value="15" placeholder="Tax Rate (%)" class="p-3 border rounded-lg" style="border-color: var(--color-border);">
                                <button onclick="addEmployee()" class="text-white font-bold py-3 rounded-xl" style="background-color: var(--color-green);">Add Employee</button>
                            </div>
                            <div id="employeeList" class="space-y-3 mt-4"></div>
                            <h4 class="text-base font-bold mt-8 mb-4 border-t pt-4" style="border-color: var(--color-border);">Run Monthly Payroll</h4>
                            <button onclick="runMonthlyPayroll()" class="w-full text-white font-bold py-4 rounded-xl shadow-md flex items-center justify-center" style="background-color: var(--color-blue);">
                                <i data-lucide="dollar-sign" class="w-5 h-5 mr-2"></i> Process Payroll for All Employees
                            </button>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-extrabold mb-4 border-b pb-2" style="color: var(--color-yellow); border-color: var(--color-border);">Equity and Debt Flow</h3>
                            <p class="text-sm mb-4" style="color: var(--color-text-dark);">Record capital movements that impact the **Balance Sheet**.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border p-4 rounded-xl" style="background-color: #2D3748; border-color: var(--color-border);">
                                <select id="capitalType" class="p-3 border rounded-lg" style="border-color: var(--color-border);">
                                    <option value="Equity-Contribution">Owner Contribution (Equity +)</option>
                                    <option value="Equity-Drawing">Owner Drawing (Equity -)</option>
                                    <option value="Debt-Loan">Loan Received (Debt +)</option>
                                    <option value="Debt-Repayment">Loan Repayment (Debt -)</option>
                                </select>
                                <input type="number" id="capitalAmount" placeholder="Amount ($)" class="p-3 border rounded-lg" style="border-color: var(--color-border);">
                                <button onclick="recordCapital()" class="text-white font-bold py-3 rounded-xl" style="background-color: var(--color-red);">Record Flow</button>
                            </div>
                            <h4 class="text-base font-bold mt-6 mb-3 border-t pt-4" style="border-color: var(--color-border);">Capital Transaction History</h4>
                            <div id="capitalHistory" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer>Made In India <br> with ❤️ Utkarsh</footer>
    </div>
    
    <div id="invoicePrintContainer" style="visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0;">
        <div id="invoiceTemplate" class="p-10 bg-white shadow-xl max-w-4xl mx-auto my-10 border border-gray-200"></div>
    </div>

    <script>
        // --- JAVASCRIPT: Authentication Logic ---
        function toggleAuthForms() {
            const signInForm = document.getElementById('signin-form');
            const signUpForm = document.getElementById('signup-form');
            if (signInForm.style.display === 'none') {
                signInForm.style.display = 'block';
                signUpForm.style.display = 'none';
            } else {
                signInForm.style.display = 'none';
                signUpForm.style.display = 'block';
            }
        }

        function signIn() {
            // Placeholder for real sign-in logic. For now, it just hides the auth and shows the app.
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            initApp(); // Initialize the app after "signing in"
        }

        function signUp() {
            // Placeholder for real sign-up logic.
            alert("Sign up successful! Please sign in.");
            toggleAuthForms();
        }

        // --- JAVASCRIPT: Application Data and Core Functions ---
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let capitalTransactions = JSON.parse(localStorage.getItem('capitalTransactions')) || [];
        let payrollLiability = parseFloat(localStorage.getItem('payrollLiability')) || 0;
        
        let netFlowChartInstance;
        let expenseCategoryChartInstance;

        const categories = {
            Income: ['-- Auto-Classify --', 'Client Service Fee', 'Product Sales', 'Subscription Revenue', 'Interest Income', 'Grants & Subsidies', 'Other Income'],
            Expense: ['-- Auto-Classify --', 'Salaries & Wages', 'Software & Subscriptions', 'Office Rent & Utilities', 'Marketing & Advertising', 'Travel & Lodging', 'Professional Services (Legal/Acct)', 'Equipment Purchase', 'General Supplies', 'Other Expense']
        };
        
        // --- UI & UX Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Don't initApp here, it will be called after "sign in"
        });

        function initApp() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            document.getElementById('dateInput').value = new Date().toISOString().slice(0, 10);
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            
            updateCategoryDropdown();
            switchTab('ledger'); // Set the default tab
            renderLedger();
            updateSummaryAndChart();
            updateCalculations();
            updateInvoiceCalculations();
            updateInvoiceDisplay();
            renderEmployeeList();
            renderCapitalHistory();
        }
        
        function switchTab(tabId) { 
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            const activeContent = document.getElementById(tabId);
            if(activeContent) {
                activeContent.classList.add('active');
                activeContent.style.display = 'block';
            }

            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if(activeButton) {
                activeButton.classList.add('active');
            }

            if (tabId === 'analysis') updateSummaryAndChart();
            if (tabId === 'payroll') { renderEmployeeList(); renderCapitalHistory(); }
        }
        
        function updateCategoryDropdown() {
            const type = document.getElementById('typeSelect').value;
            const categorySelect = document.getElementById('categorySelect');
            categorySelect.innerHTML = '';
            const relevantCategories = categories[type] || [];
            relevantCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            updateCalculations();
        }

        function getFinalCategory(description, type, userCategory) {
            if (userCategory && userCategory !== '-- Auto-Classify --') return userCategory;
            const desc = description.toLowerCase();
            if (type === 'Income') {
                if (desc.includes('client') || desc.includes('fee')) return 'Client Service Fee';
                if (desc.includes('sale') || desc.includes('shop')) return 'Product Sales';
                if (desc.includes('interest')) return 'Interest Income';
                return 'Other Income';
            } else {
                if (desc.includes('salary') || desc.includes('wage') || desc.includes('payroll')) return 'Salaries & Wages';
                if (desc.includes('adobe') || desc.includes('zoom') || desc.includes('saas') || desc.includes('software') || desc.includes('subscription')) return 'Software & Subscriptions';
                if (desc.includes('rent') || desc.includes('utility') || desc.includes('electric')) return 'Office Rent & Utilities';
                if (desc.includes('ad') || desc.includes('marketing') || desc.includes('facebook')) return 'Marketing & Advertising';
                if (desc.includes('legal') || desc.includes('accounting') || desc.includes('tax')) return 'Professional Services (Legal/Acct)';
                return 'Other Expense';
            }
        }

        function updateCalculations() {
            const amountStr = document.getElementById('amountInput').value.trim();
            const userCategory = document.getElementById('categorySelect').value;
            const description = document.getElementById('descriptionInput').value.trim();
            const type = document.getElementById('typeSelect').value;
            const amount = parseFloat(amountStr);
            const saveButton = document.getElementById('recordButton');
            document.getElementById('calcCategory').textContent = 'Category: [Waiting for Input]';
            document.getElementById('calcValue').textContent = 'Bookkeeping Value: $0.00';
            saveButton.disabled = true;
            if (!amountStr || isNaN(amount) || amount <= 0) return;
            const category = getFinalCategory(description, type, userCategory);
            document.getElementById('calcCategory').textContent = `Category: ${category}`;
            document.getElementById('calcValue').textContent = `Bookkeeping Value: $${amount.toFixed(2)}`;
            if (category !== '-- Auto-Classify --' && amount > 0 && description) {
                saveButton.disabled = false;
            }
        }

        function addTransaction() {
            const description = document.getElementById('descriptionInput').value.trim();
            const amountStr = document.getElementById('amountInput').value.trim();
            const type = document.getElementById('typeSelect').value;
            const userCategory = document.getElementById('categorySelect').value;
            const amount = parseFloat(amountStr);
            if (!description || !amount || amount <= 0) {
                return showMessage("Input Error", "Please fill in all transaction details with a valid positive amount.", "bg-red-500");
            }
            const finalCategory = getFinalCategory(description, type, userCategory);
            const newTransaction = {
                id: Math.random().toString(36).substring(2, 10),
                date: document.getElementById('dateInput').value,
                type: type,
                description: description,
                value: amount,
                category: finalCategory,
                source: 'Manual'
            };
            transactions.push(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderLedger();
            updateSummaryAndChart();
            document.getElementById('descriptionInput').value = '';
            document.getElementById('amountInput').value = '';
            document.getElementById('typeSelect').value = 'Expense';
            updateCategoryDropdown();
            updateCalculations();
            showMessage("Recorded", `Transaction ${newTransaction.id} saved successfully.`, "bg-blue-600");
        }

        function renderLedger() {
            const body = document.getElementById('ledgerBody');
            body.innerHTML = '';
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                const row = body.insertRow();
                row.className = 'text-sm hover:bg-gray-700 transition duration-100';
                row.insertCell().textContent = t.id;
                row.insertCell().textContent = t.date;
                const typeCell = row.insertCell();
                typeCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.type === 'Income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${t.type}</span>`;
                row.insertCell().textContent = t.description;
                const valueCell = row.insertCell();
                valueCell.className = 'text-right px-4 py-3 font-medium';
                valueCell.textContent = `$${t.value.toFixed(2)}`;
                row.insertCell().textContent = t.category;
            });
        }
        
        function updateSummaryAndChart() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((acc, t) => acc + t.value, 0);
            const totalExpense = transactions.filter(t => t.type === 'Expense').reduce((acc, t) => acc + t.value, 0);
            const net = totalIncome - totalExpense;

            document.getElementById('summaryIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('summaryExpense').textContent = `$${totalExpense.toFixed(2)}`;
            document.getElementById('summaryNet').textContent = `$${net.toFixed(2)}`;
            document.getElementById('summaryNet').style.color = net >= 0 ? 'var(--color-green)' : 'var(--color-red)';
            
            renderNetFlowChart(totalIncome, totalExpense);
            renderExpenseCategoryChart();
            renderPnL();
            renderBalanceSheet();
        }

        function renderNetFlowChart(income, expense) {
            const ctx = document.getElementById('netFlowChart').getContext('2d');
            if (netFlowChartInstance) netFlowChartInstance.destroy();
            netFlowChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Total Income', 'Total Expense'],
                    datasets: [{
                        data: [income, expense],
                        backgroundColor: ['#68D391', '#F56565'], // CHANGED: Hardcoded theme colors
                        borderColor: '#4A5568', // Updated to match card background
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#F7FAFC' } }, // Updated to match text color
                        tooltip: { callbacks: { label: (c) => `${c.label}: $${c.raw.toFixed(2)}` } }
                    }
                }
            });
        }

        function renderExpenseCategoryChart() {
            const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
            const expenseData = transactions.filter(t => t.type === 'Expense').reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.value;
                return acc;
            }, {});
            const sortedExpenses = Object.entries(expenseData).sort(([, a], [, b]) => b - a);
            const labels = sortedExpenses.map(item => item[0]);
            const data = sortedExpenses.map(item => item[1]);
            // CHANGED: New color palette using your theme colors
            const backgroundColors = ['#F56565', '#F6E05E', '#63B3ED', '#68D391', '#A78BFA', '#F472B6'];

            if (expenseCategoryChartInstance) expenseCategoryChartInstance.destroy();
            expenseCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expense by Category',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#4A5568', // Updated to match card background
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => `${c.label}: $${c.raw.toFixed(2)}` } }
                    },
                    scales: {
                        x: { ticks: { color: '#A0AEC0' }, grid: { color: '#4A5568' } }, // Updated to match theme
                        y: { ticks: { color: '#A0AEC0' }, grid: { display: false } }     // Updated to match theme
                    }
                }
            });
        }
        
        function renderPnL() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((acc, t) => acc + t.value, 0);
            const totalExpense = transactions.filter(t => t.type === 'Expense').reduce((acc, t) => acc + t.value, 0);
            const netProfit = totalIncome - totalExpense;
            const pnlBody = document.getElementById('pnlBody');
            pnlBody.innerHTML = `
                <table class="min-w-full text-sm">
                    <tbody>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Total Revenue (Income)</td><td class="text-right font-semibold" style="color: var(--color-green);">$${totalIncome.toFixed(2)}</td></tr>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Total Operating Expenses</td><td class="text-right font-semibold" style="color: var(--color-red);">$${totalExpense.toFixed(2)}</td></tr>
                        <tr class="font-bold"><td class="py-3 pr-4">Net Profit / Loss</td><td class="text-right text-lg" style="color: ${netProfit >= 0 ? 'var(--color-green)' : 'var(--color-red)'};">$${netProfit.toFixed(2)}</td></tr>
                    </tbody>
                </table>
            `;
        }
        
        function renderBalanceSheet() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((acc, t) => acc + t.value, 0);
            const totalExpense = transactions.filter(t => t.type === 'Expense').reduce((acc, t) => acc + t.value, 0);
            const retainedEarnings = totalIncome - totalExpense;

            const ownerContribution = capitalTransactions.filter(t => t.type === 'Equity-Contribution').reduce((acc, t) => acc + t.amount, 0);
            const ownerDrawing = capitalTransactions.filter(t => t.type === 'Equity-Drawing').reduce((acc, t) => acc + t.amount, 0);
            const equity = ownerContribution - ownerDrawing + retainedEarnings;
            
            const loansReceived = capitalTransactions.filter(t => t.type === 'Debt-Loan').reduce((acc, t) => acc + t.amount, 0);
            const loansRepaid = capitalTransactions.filter(t => t.type === 'Debt-Repayment').reduce((acc, t) => acc + t.amount, 0);
            const debt = loansReceived - loansRepaid;

            const cash = totalIncome - totalExpense + ownerContribution - ownerDrawing + loansReceived - loansRepaid;
            const assets = cash;
            const liabilitiesAndEquity = debt + payrollLiability + equity;

            const bsBody = document.getElementById('bsBody');
            bsBody.innerHTML = `
                <table class="min-w-full text-sm">
                    <thead><tr><th class="text-left py-2 font-semibold" style="color: var(--color-green);">Assets</th><th></th></tr></thead>
                    <tbody>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Cash</td><td class="text-right">$${cash.toFixed(2)}</td></tr>
                        <tr class="font-bold"><td class="py-3 pr-4">Total Assets</td><td class="text-right">$${assets.toFixed(2)}</td></tr>
                    </tbody>
                    <thead><tr><th class="text-left py-4 font-semibold" style="color: var(--color-red);">Liabilities</th><th></th></tr></thead>
                    <tbody>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Loans Payable</td><td class="text-right">$${debt.toFixed(2)}</td></tr>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Payroll Tax Payable</td><td class="text-right">$${payrollLiability.toFixed(2)}</td></tr>
                        <tr class="font-bold"><td class="py-3 pr-4">Total Liabilities</td><td class="text-right">$${(debt + payrollLiability).toFixed(2)}</td></tr>
                    </tbody>
                    <thead><tr><th class="text-left py-4 font-semibold" style="color: var(--color-yellow);">Equity</th><th></th></tr></thead>
                    <tbody>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Owner's Capital</td><td class="text-right">$${(ownerContribution - ownerDrawing).toFixed(2)}</td></tr>
                        <tr class="border-b" style="border-color: var(--color-border);"><td class="py-2 pr-4">Retained Earnings</td><td class="text-right">$${retainedEarnings.toFixed(2)}</td></tr>
                        <tr class="font-bold"><td class="py-3 pr-4">Total Equity</td><td class="text-right">$${equity.toFixed(2)}</td></tr>
                    </tbody>
                    <tfoot><tr class="font-extrabold text-base border-t-2" style="border-color: var(--color-text-light);"><td class="py-4 pr-4">Total Liabilities & Equity</td><td class="text-right">$${liabilitiesAndEquity.toFixed(2)}</td></tr></tfoot>
                </table>
            `;
        }

        function updateInvoiceCalculations() {
            const netPrice = parseFloat(document.getElementById('invoiceNetPrice').value) || 0;
            const gstRate = parseFloat(document.getElementById('invoiceGstRate').value) || 0;
            const gstAmount = netPrice * (gstRate / 100);
            const total = netPrice + gstAmount;
            document.getElementById('invoiceCalcOutput').innerHTML = `
                Net: <strong>$${netPrice.toFixed(2)}</strong> | Tax (${gstRate}%): <strong>$${gstAmount.toFixed(2)}</strong> | TOTAL: <strong class="text-lg">$${total.toFixed(2)}</strong>
            `;
        }

        function updateInvoiceDisplay() {
            const preview = document.getElementById('invoicePreview');
            const companyName = document.getElementById('companyName').value;
            const companyAddress = document.getElementById('companyAddress').value;
            const clientName = document.getElementById('invoiceClientName').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const description = document.getElementById('invoiceDescription').value;
            const netPrice = parseFloat(document.getElementById('invoiceNetPrice').value) || 0;
            const gstRate = parseFloat(document.getElementById('invoiceGstRate').value) || 0;
            const gstAmount = netPrice * (gstRate / 100);
            const total = netPrice + gstAmount;

            preview.innerHTML = `
                <div style="font-family: Arial, sans-serif; color: var(--color-text-light);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--color-blue); padding-bottom: 1rem; margin-bottom: 2rem;">
                        <div>
                            <h2 style="font-size: 1.8rem; font-weight: bold; margin: 0; color: var(--color-blue);">${companyName}</h2>
                            <p style="margin: 0.25rem 0 0; color: var(--color-text-dark);">${companyAddress}</p>
                        </div>
                        <h1 style="font-size: 2.5rem; font-weight: bold; margin: 0; color: var(--color-text-dark);">INVOICE</h1>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                        <div>
                            <p style="margin: 0; font-weight: bold;">BILLED TO:</p>
                            <p style="margin: 0.25rem 0 0;">${clientName || 'Client Name'}</p>
                            <p style="margin: 0.25rem 0 0;">${clientEmail || 'client.email@example.com'}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0;"><strong>Invoice #:</strong> INV-${new Date().getFullYear()}-001</p>
                            <p style="margin: 0.25rem 0 0;"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                        <thead style="background-color: #2D3748;">
                            <tr>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--color-border);">Description</th>
                                <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--color-border);">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid var(--color-border);">${description || 'Service Description'}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--color-border);">$${netPrice.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="width: 50%;">
                            <table style="width: 100%;">
                                <tbody>
                                    <tr>
                                        <td style="padding: 0.5rem 0; text-align: right;">Subtotal:</td>
                                        <td style="padding: 0.5rem 0; text-align: right;">$${netPrice.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.5rem 0; text-align: right;">Tax (${gstRate}%):</td>
                                        <td style="padding: 0.5rem 0; text-align: right;">$${gstAmount.toFixed(2)}</td>
                                    </tr>
                                    <tr style="font-weight: bold; font-size: 1.2rem; border-top: 2px solid var(--color-blue);">
                                        <td style="padding: 0.75rem 0; text-align: right;">Total Due:</td>
                                        <td style="padding: 0.75rem 0; text-align: right;">$${total.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div style="margin-top: 3rem; text-align: center; font-size: 0.8rem; color: var(--color-text-dark);">
                        <p>Thank you for your business! Please make payment within 30 days.</p>
                    </div>
                </div>
            `;
        }

        function downloadInvoice() {
            const invoiceContent = document.getElementById('invoicePreview').innerHTML;
            const printContainer = document.getElementById('invoiceTemplate');
            printContainer.innerHTML = invoiceContent;
            window.print();
        }

        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const salary = parseFloat(document.getElementById('employeeSalary').value);
            const taxRate = parseFloat(document.getElementById('employeeTaxRate').value);

            if (!name || !salary || salary <= 0 || !taxRate || taxRate < 0) {
                return showMessage("Employee Error", "Please provide a valid name, positive salary, and tax rate.", "bg-red-500");
            }

            employees.push({ id: `E${employees.length + 1}`, name, salary, taxRate });
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployeeList();
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeSalary').value = '';
            document.getElementById('employeeTaxRate').value = '15';
        }

        function renderEmployeeList() {
            const list = document.getElementById('employeeList');
            list.innerHTML = '';
            if (employees.length === 0) {
                list.innerHTML = `<p class="text-sm text-center" style="color: var(--color-text-dark);">No employees added yet.</p>`;
                return;
            }
            employees.forEach((emp, index) => {
                const empDiv = document.createElement('div');
                empDiv.className = 'flex justify-between items-center p-3 rounded-lg';
                empDiv.style.backgroundColor = '#2D3748';
                empDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${emp.name}</p>
                        <p class="text-xs" style="color: var(--color-text-dark);">Annual Salary: $${emp.salary.toFixed(2)} | Tax Rate: ${emp.taxRate}%</p>
                    </div>
                    <button onclick="removeEmployee(${index})" class="p-2 rounded-full hover:bg-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(empDiv);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function removeEmployee(index) {
            employees.splice(index, 1);
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployeeList();
        }

        function runMonthlyPayroll() {
            if (employees.length === 0) {
                return showMessage("Payroll Error", "No employees to run payroll for.", "bg-yellow-500 text-black");
            }
            let totalSalaryExpense = 0;
            let totalTaxWithheld = 0;
            employees.forEach(emp => {
                const monthlySalary = emp.salary / 12;
                const monthlyTax = monthlySalary * (emp.taxRate / 100);
                totalSalaryExpense += monthlySalary;
                totalTaxWithheld += monthlyTax;
            });
            payrollLiability += totalTaxWithheld;
            localStorage.setItem('payrollLiability', payrollLiability);
            
            const payrollTransaction = {
                id: `P${Math.random().toString(36).substring(2, 8)}`,
                date: new Date().toISOString().slice(0, 10),
                type: 'Expense',
                description: `Monthly Payroll for ${employees.length} employees`,
                value: totalSalaryExpense,
                category: 'Salaries & Wages',
                source: 'Payroll Automation'
            };
            transactions.push(payrollTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            renderLedger();
            updateSummaryAndChart();
            showMessage("Payroll Processed", `Total Salary Expense: $${totalSalaryExpense.toFixed(2)}\nTax Liability Increased by: $${totalTaxWithheld.toFixed(2)}`, "bg-green-500");
        }

        function recordCapital() {
            const type = document.getElementById('capitalType').value;
            const amount = parseFloat(document.getElementById('capitalAmount').value);
            if (!amount || amount <= 0) {
                return showMessage("Capital Error", "Please enter a valid positive amount.", "bg-red-500");
            }
            const record = {
                id: `C${Date.now()}`,
                date: new Date().toISOString().slice(0, 10),
                type: type,
                amount: amount,
                description: type.replace('-', ' ')
            };
            capitalTransactions.push(record);
            localStorage.setItem('capitalTransactions', JSON.stringify(capitalTransactions));
            renderCapitalHistory();
            updateSummaryAndChart(); // Balance sheet is affected
            document.getElementById('capitalAmount').value = '';
            showMessage("Capital Flow Recorded", `${record.description} of $${record.amount.toFixed(2)}`, "bg-blue-600");
        }
        
        function renderCapitalHistory() {
            const history = document.getElementById('capitalHistory');
            history.innerHTML = '';
            if (capitalTransactions.length === 0) {
                history.innerHTML = `<p class="text-xs text-center" style="color: var(--color-text-dark);">No capital movements recorded.</p>`;
                return;
            }
            capitalTransactions.slice().reverse().forEach(cap => {
                const isPositive = cap.type.includes('Contribution') || cap.type.includes('Loan');
                const color = isPositive ? 'text-green-400' : 'text-red-400';
                const sign = isPositive ? '+' : '-';
                const recordDiv = document.createElement('div');
                recordDiv.className = 'flex justify-between items-center p-2 rounded';
                recordDiv.style.backgroundColor = '#2D3748';
                recordDiv.innerHTML = `
                    <p>${cap.date}: ${cap.description}</p>
                    <p class="font-semibold ${color}">${sign}$${cap.amount.toFixed(2)}</p>
                `;
                history.appendChild(recordDiv);
            });
        }

        function exportData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Date,Type,Description,Value,Category,Source\n";
            transactions.forEach(tx => {
                csvContent += `${tx.id},${tx.date},${tx.type},"${tx.description}",${tx.value},${tx.category},${tx.source}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `finledger_export_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showMessage(title, message, colorClass, duration = 4000) {
            const container = document.getElementById('app');
            let msgBox = document.getElementById('messageBox');

            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'messageBox';
                msgBox.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300'; 
                container.appendChild(msgBox);
            }

            const formattedMessage = message.split('\n').map(line => `<p class="text-sm">${line}</p>`).join('');

            msgBox.innerHTML = `<p class="font-bold">${title}</p>${formattedMessage}`;
            msgBox.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 ${colorClass}`;
            msgBox.style.opacity = 1;

            clearTimeout(msgBox.timer);
            msgBox.timer = setTimeout(() => {
                msgBox.style.opacity = 0;
            }, duration);
        }
    </script>
</body>
</html>
